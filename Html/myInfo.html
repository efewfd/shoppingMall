<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../Css/myInfo.css" />
  <link rel="stylesheet" href="../Css/home.css" />
  <title>MY ì •ë³´</title>
</head>
<body>
    <div class="Navbar">
        <h1 class="logo"><a href="home.html">Shopping Mall</a></h1>
        <ul class="products">
          <li>
            <a href="./outerwear/outerwear.html">ì•„ìš°í„°</a>
            <div class="sub-category">
              <ul>
                <li><a href="./outerwear/coat.html">ì½”íŠ¸</a></li>
                <li><a href="./outerwear/jacket.html">ìì¼“</a></li>
                <li><a href="./outerwear/cardigan.html">ê°€ë””ê±´</a></li>
                <li><a href="./outerwear/vest.html">ì¡°ë¼</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./top/consultation.html">ìƒì˜</a>
            <div class="sub-category">
              <ul>
                <li><a href="./top/basic.html">ê¸°ë³¸</a></li>
                <li><a href="./top/casual.html">ìºì£¼ì–¼</a></li>
                <li><a href="./top/sweatshirt.html">ë§¨íˆ¬ë§¨</a></li>
                <li><a href="./top/hoddie.html">í›„ë“œí‹°</a></li>
                <li><a href="./top/shirt.html">ì…”ì¸ </a></li>
                <li><a href="./top/blouse.html">ë¸”ë¼ìš°ìŠ¤</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./bottom/bottom.html">í•˜ì˜</a>
            <div class="sub-category">
              <ul>
                <li><a href="./bottom/denim.html">ë°ë‹˜</a></li>
                <li><a href="./bottom/short.html">ë°˜ë°”ì§€</a></li>
                <li><a href="./bottom/cotton.html">ì½”íŠ¼</a></li>
                <li><a href="./bottom/leggings.html">ë ˆê¹…ìŠ¤</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./dress/dress.html">ì›í”¼ìŠ¤</a>
            <div class="sub-category">
              <ul>
                <li><a href="./dress/dress-min.html">ë¯¸ë‹ˆ</a></li>
                <li><a href="./dress/dress-long.html">ë¡±</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./skirt/skirt.html">ìŠ¤ì»¤íŠ¸</a>
            <div class="sub-category">
              <ul>
                <li><a href="./skirt/skirt-min.html">ë¯¸ë‹ˆ</a></li>
                <li><a href="./skirt/skirt-long.html">ë¡±</a></li>
              </ul>
            </div>
          </li>
        </ul>
        <ul class="listbar">
        </ul>
    </div>
  <div class="container">
    <header>MY Page</header>
    <div class="main-section">
      <aside class="side-menu">
        <ul>
          <li class="active">MY ì •ë³´</li>
          <li><a href="cart.html">ì¥ë°”êµ¬ë‹ˆ</a></li>
          <li><a href="delivery.html">ë°°ì†¡ì¡°íšŒ</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="#">1:1 ë¬¸ì˜</a></li>
        </ul>
      </aside>

      <section class="content">
        <div class="user-info">
          <p><strong>ì•ˆë…•í•˜ì„¸ìš”, <span id="username">â—‹â—‹â—‹</span>ë‹˜</strong></p>
          <p>ì´ë©”ì¼: <input type="email" id="email" disabled /></p>
          <p>ì´ë¦„: <input type="text" id="name" disabled /></p>
          <button class="edit-btn" id="editBtn">íšŒì›ì •ë³´ ìˆ˜ì •</button>
          <button id="saveBtn" style="display: none;">ì €ì¥</button>
        </div>

        <div class="section">
          <div class="section-title">ì£¼ë¬¸ ë‚´ì—­</div>
          <div id="order-container">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div class="section">
          <div class="section-title">ì°œí•œ ìƒí’ˆ</div>
          <div id="wishlist-container">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>
    </div>
  </div>
  <script>
    window.addEventListener("DOMContentLoaded", async () => {
    // âœ… ì„¸ì…˜ ê¸°ë°˜ ì‚¬ìš©ì í™•ì¸
    const sessionRes = await fetch("/api/auth/user", { credentials: "include" });
    const sessionData = await sessionRes.json();
    console.log("ì„¸ì…˜ ì‘ë‹µ:", sessionData);
    if (!sessionData.loggedIn) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "/Login.html";
      return;
    }

    const userId = sessionData.user.userId;
    console.log("userId í™•ì¸:", userId);

    // âœ… íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    try {
      const res = await fetch(`/api/users/${userId}`, { credentials: "include" });
      if (!res.ok) throw new Error("íšŒì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
      const user = await res.json();

      document.getElementById("username").textContent = user.name;
      document.getElementById("email").value = user.email;
      document.getElementById("name").value = user.name;
    } catch (err) {
      console.error("íšŒì› ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    }

    // âœ… ìˆ˜ì • ë²„íŠ¼
    document.getElementById("editBtn").addEventListener("click", () => {
      document.getElementById("email").disabled = false;
      document.getElementById("name").disabled = false;
      document.getElementById("editBtn").style.display = "none";
      document.getElementById("saveBtn").style.display = "inline-block";
    });

    // âœ… ì €ì¥ ë²„íŠ¼
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;

      try {
        const res = await fetch(`/api/users/${userId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          credentials: "include", // âœ… ì„¸ì…˜ ìœ ì§€
          body: JSON.stringify({ name, email })
        });
        const data = await res.json();
        alert(data.message);

        // UI ë°˜ì˜
        document.getElementById("username").textContent = name;
        document.getElementById("email").disabled = true;
        document.getElementById("name").disabled = true;
        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("saveBtn").style.display = "none";
      } catch (err) {
        console.error("íšŒì› ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:", err);
      }
    });

    // âœ… ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
    try {
      console.log("ğŸ“¡ fetch ì£¼ë¬¸ ë‚´ì—­ ì‹œì‘");

      const orderRes = await fetch(`/api/orders/${userId}`, {
        method: 'GET',
        credentials: 'include',
        cache: 'no-store'
      });

      if (!orderRes.ok) {
        const errorText = await orderRes.text();
        console.error(`âŒ ì£¼ë¬¸ ë‚´ì—­ ì‘ë‹µ ì‹¤íŒ¨: ${orderRes.status}`, errorText);
        document.getElementById("order-container").innerHTML = "<p>ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const orders = await orderRes.json();
      console.log("âœ… ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì£¼ë¬¸ ëª©ë¡:", orders);


      const validatedOrders = orders.filter(order =>
        order.product && order.product.title && order.product.image
      );

      const orderContainer = document.getElementById("order-container");

      if (!validatedOrders.length) {
        orderContainer.innerHTML = "<p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      orderContainer.innerHTML = validatedOrders.map(order => {
        const created = new Date(order.createdAt).toLocaleDateString();
        return `
          <div class="order-item">
            <img src="${order.product.image || '/images/default.png'}" alt="ìƒí’ˆ ì´ë¯¸ì§€"
                style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;" />
            <div>
              <p><strong>${order.product.title || 'ìƒí’ˆëª… ì—†ìŒ'}</strong></p>
              <p>ì£¼ë¬¸ì¼: ${created}</p>
              <p>ìˆ˜ëŸ‰: ${order.quantity}</p>
              <p>ìƒíƒœ: ${order.status}</p>
            </div>
          </div>
        `;
      }).join('');
    } catch (err) {
      console.error("âŒ ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      document.getElementById("order-container").innerHTML = "<p>ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
    }

    // âœ… ì°œí•œ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° (MySQL ë²„ì „)
    try {
      const res = await fetch(`/api/wishlist/${userId}`, { credentials: "include" });
      const wishlist = await res.json();

      const container = document.getElementById("wishlist-container");

      if (!wishlist.length) {
        container.innerHTML = "<p>ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      container.innerHTML = wishlist.map(item => `
        <div class="wishlist-item" data-product-id="${item.id}">
          <img src="${item.image_url}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px;" />
          <strong>${item.name}</strong> (${parseInt(item.price).toLocaleString()}ì›)
          <button class="remove-wishlist-btn" style="margin-left: 10px;">â™¥</button>
        </div>
      `).join('');

      // âœ… ì°œí•œ ìƒí’ˆ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      document.querySelectorAll(".wishlist-item").forEach(item => {
        item.addEventListener("click", (e) => {
          if (e.target.classList.contains("remove-wishlist-btn")) return;
          const productId = item.dataset.productId;
          if (productId) {
            window.location.href = `/productDetail.html?id=${productId}`;
          }
        });
      });

    } catch (error) {
      console.error("ì°œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }

    // âœ… â™¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì°œ ì‚­ì œ
    document.querySelectorAll(".remove-wishlist-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

        const item = e.target.closest(".wishlist-item");
        const productId = item.dataset.productId;

        if (!confirm("ì°œ ëª©ë¡ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
          const res = await fetch("/api/wishlist", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, productId })
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "ì‚­ì œ ì‹¤íŒ¨");

          // DOMì—ì„œ í•­ëª© ì œê±°
          item.remove();

          // ë¹ˆ ìƒíƒœ ì²˜ë¦¬
          if (document.querySelectorAll(".wishlist-item").length === 0) {
            document.getElementById("wishlist-container").innerHTML = "<p>ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          }

        } catch (err) {
          console.error("ì°œ ì‚­ì œ ì‹¤íŒ¨:", err);
          alert("ì°œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });
  });
  </script>
  <script src="../js/navbar.js"></script>
</body>
</html>
