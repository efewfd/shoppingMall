<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../Css/myInfo.css" />
  <link rel="stylesheet" href="../Css/home.css" />
  <title>MY 정보</title>
</head>
<body>
    <div class="Navbar">
        <h1 class="logo"><a href="home.html">Shopping Mall</a></h1>
        <ul class="products">
          <li>
            <a href="./outerwear/outerwear.html">아우터</a>
            <div class="sub-category">
              <ul>
                <li><a href="./outerwear/coat.html">코트</a></li>
                <li><a href="./outerwear/jacket.html">자켓</a></li>
                <li><a href="./outerwear/cardigan.html">가디건</a></li>
                <li><a href="./outerwear/vest.html">조끼</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./top/consultation.html">상의</a>
            <div class="sub-category">
              <ul>
                <li><a href="./top/basic.html">기본</a></li>
                <li><a href="./top/casual.html">캐주얼</a></li>
                <li><a href="./top/sweatshirt.html">맨투맨</a></li>
                <li><a href="./top/hoddie.html">후드티</a></li>
                <li><a href="./top/shirt.html">셔츠</a></li>
                <li><a href="./top/blouse.html">블라우스</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./bottom/bottom.html">하의</a>
            <div class="sub-category">
              <ul>
                <li><a href="./bottom/denim.html">데님</a></li>
                <li><a href="./bottom/short.html">반바지</a></li>
                <li><a href="./bottom/cotton.html">코튼</a></li>
                <li><a href="./bottom/leggings.html">레깅스</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./dress/dress.html">원피스</a>
            <div class="sub-category">
              <ul>
                <li><a href="./dress/dress-min.html">미니</a></li>
                <li><a href="./dress/dress-long.html">롱</a></li>
              </ul>
            </div>
          </li>
          <li>
            <a href="./skirt/skirt.html">스커트</a>
            <div class="sub-category">
              <ul>
                <li><a href="./skirt/skirt-min.html">미니</a></li>
                <li><a href="./skirt/skirt-long.html">롱</a></li>
              </ul>
            </div>
          </li>
        </ul>
        <ul class="listbar">
        </ul>
    </div>
  <div class="container">
    <header>MY Page</header>
    <div class="main-section">
      <aside class="side-menu">
        <ul>
          <li class="active">MY 정보</li>
          <li><a href="cart.html">장바구니</a></li>
          <li><a href="delivery.html">배송조회</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="#">1:1 문의</a></li>
        </ul>
      </aside>

      <section class="content">
        <div class="user-info">
          <p><strong>안녕하세요, <span id="username">○○○</span>님</strong></p>
          <p>이메일: <input type="email" id="email" disabled /></p>
          <p>이름: <input type="text" id="name" disabled /></p>
          <button class="edit-btn" id="editBtn">회원정보 수정</button>
          <button id="saveBtn" style="display: none;">저장</button>
        </div>

        <div class="section">
          <div class="section-title">최근 결제 내역</div>
          <div id="order-container">불러오는 중...</div>
        </div>

        <div class="section">
          <div class="section-title">찜한 상품</div>
          <div id="wishlist-container">불러오는 중...</div>
        </div>

        <script>
          window.addEventListener("DOMContentLoaded", async () => {
            const userId = localStorage.getItem("userId");
            if (!userId) {
              alert("로그인이 필요합니다.");
              return;
            }
            //  회원 정보 가져오기
            try {
              const res = await fetch(`/api/users/${userId}`);
              if (!res.ok) throw new Error("회원 정보 조회 실패");
              const user = await res.json();

              document.getElementById('username').textContent = user.name;
              document.getElementById('email').value = user.email;
              document.getElementById('name').value = user.name;
            } catch(err) {
              console.error("회원 정보 불러오기 실패:", err);
            }

            // 수정 버튼 동작
            document.getElementById("editBtn").addEventListener("click", () => {
              document.getElementById("email").disabled = false;
              document.getElementById("name").disabled = false;
              document.getElementById("editBtn").style.display = "none";
              document.getElementById("saveBtn").style.display = "inline-block";
            });

            // 저장 버튼 동작
            document.getElementById("saveBtn").addEventListener("click", async () => {
              const name = document.getElementById("name").value;
              const email = document.getElementById("email").value;

              try {
                const res = await fetch(`/api/users/${userId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ name, email })
                });
                const data = await res.json();
                alert(data.message);

                // UI 반영
                document.getElementById("username").textContent = name;
                document.getElementById("email").disabled = true;
                document.getElementById("name").disabled = true;
                document.getElementById("editBtn").style.display = "inline-block";
                document.getElementById("saveBtn").style.display = "none";
              } catch(err) {
                console.error("회원 정보 수정 실패:", err);
              }
            })

            // 찜한 상품 불러오기
            try {
                const res = await fetch(`/api/wishlist/${userId}`);
                if(!res.ok) throw new Error("404 or Server Error");
                const wishlist = await res.json();

                console.log(" 받아온 wishlist:", wishlist);
                const container = document.getElementById("wishlist-container");
                if (!wishlist.length) {
                  container.innerHTML = "<p>찜한 상품이 없습니다.</p>";
                  return;
                }

                container.innerHTML = wishlist.map(item => {
                  console.log('이미지 파일명:', item.product.image);
                  return `
                  <div class="wishlist-item">
                    <img src="${item.product.image}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px; vertical-align: middle;" />
                    <strong>${item.product.title}</strong>(${item.product.price.toLocaleString()}원)
                  </div>
                  `;
                }).join('');
            } catch(error) {
                console.error("찜 목록 불러오기 실패:", error);
            }

            // 최근 주문 내역 불러오기
            try {
              const orderRes = await fetch(`/api/orders/${userId}`);
              if (!orderRes.ok) throw new Error("주문 목록 조회 실패");
              const orders = await orderRes.json();

              const orderContainer = document.getElementById("order-container");
              if (!orders.length) {
                orderContainer.innerHTML = "<p>주문 내역이 없습니다.</p>";
                return;
              }

              orderContainer.innerHTML = orders.map(order => {
                const created = new Date(order.createdAt).toLocaleDateString();
                return `
                  <div class="order-item">
                    <img src="${order.product?.image || '/default.png'}" alt="상품 이미지" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px; vertical-align: middle;"/>
                    <div>
                      <p><strong>${order.product?.title || '상품명 없음'}</strong></p>
                      <p>주문일: ${created}</p>
                      <p>수량: ${order.quantity}</p>
                      <p>상태: ${order.status}</p>
                    </div>
                  </div>
                `;
              }).join('');
            } catch(err) {
              console.error("주문 내역 불러오기 실패:", err);
            }
          });
        </script>

      </section>
    </div>
  </div>

  <script src="../js/navbar.js"></script>
</body>
</html>
