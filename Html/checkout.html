<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²°ì œ í˜ì´ì§€</title>
  <link href="../Css/home.css" rel="stylesheet" />
  <link href="../Css/cart.css" rel="stylesheet" />
  <style>
    #loader {
      display: none;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ê°€ìƒ ê²°ì œ í˜ì´ì§€</h2>
    <div id="order-summary">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <button id="payBtn">ê²°ì œí•˜ê¸°</button>
    <div id="loader"></div>
  </div>

  <script>
  window.addEventListener("DOMContentLoaded", async () => {
    const orderSummary = document.getElementById("order-summary");
    const loader = document.getElementById("loader");
    const payBtn = document.getElementById("payBtn");

    // âœ… ì„¸ì…˜ í™•ì¸ (ë¡œê·¸ì¸ ì—¬ë¶€)
    const sessionRes = await fetch("/api/auth/user", { credentials: "include" });
    const sessionData = await sessionRes.json();
    if (!sessionData.loggedIn || !sessionData.user) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "/Login.html";
      return;
    }
    const userId = sessionData.user.userId;

    // âœ… ê²°ì œí•  ìƒí’ˆ ëª©ë¡ (pendingOrders)
    const cart = JSON.parse(localStorage.getItem("pendingOrders") || "[]");
    if (!cart.length) {
      alert("ê²°ì œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
      window.location.href = "home.html";
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    orderSummary.innerHTML = cart.map(item => `
      <div>
        <strong>${item.title || "ìƒí’ˆëª… ì—†ìŒ"}</strong> - 
        ìˆ˜ëŸ‰: ${item.quantity || 1}ê°œ - 
        ê°€ê²©: ${(item.price || 0).toLocaleString()}ì›
      </div>
    `).join('') + `<hr><strong>ì´ ê²°ì œ ê¸ˆì•¡: ${total.toLocaleString()}ì›</strong>`;

    // âœ… ê²°ì œ ë²„íŠ¼ í´ë¦­
    payBtn.addEventListener("click", async () => {
      loader.style.display = "block";
      payBtn.disabled = true;
      payBtn.textContent = "ê²°ì œ ì§„í–‰ ì¤‘...";

      try {
        for (const item of cart) {
          if (!item.code || !item.quantity) throw new Error("ìƒí’ˆ ì •ë³´ ëˆ„ë½");
          console.log("ğŸ“¦ ì£¼ë¬¸ ìš”ì²­ payload:", {
            userId,
            productId: item.code,
            quantity: item.quantity,
            product: {
              title: item.title,
              image: item.image
            }
          });

          const res = await fetch("/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              userId,
              productId: item.code,
              quantity: item.quantity,
              status: "ê²°ì œì™„ë£Œ",
              product: {
                title: item.title || item.name || "ì´ë¦„ì—†ìŒ",
                image: item.image || ""
              }
            })
          });

          const data = await res.json();

          if (!res.ok) {
            alert(`âŒ ${item.title} ì£¼ë¬¸ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            throw new Error(`${item.title} ì£¼ë¬¸ ì‹¤íŒ¨`);
          }
        }

        // âœ… ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
        setTimeout(() => {
          alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
          localStorage.removeItem("cart");
          localStorage.removeItem("pendingOrders");
          window.location.href = "delivery.html";
        }, 1500);

      } catch (err) {
        console.error("âŒ ê²°ì œ ì‹¤íŒ¨:", err);
        alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        loader.style.display = "none";
        payBtn.disabled = false;
        payBtn.textContent = "ê²°ì œí•˜ê¸°";
      }
    });
  });
  </script>

</body>
</html>